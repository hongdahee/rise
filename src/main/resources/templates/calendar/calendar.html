<html lang='en'>
<head>
    <meta charset='utf-8' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.18/index.global.min.js'></script>
    <style>
        body {
          font-family: Arial, sans-serif;
          margin: 40px;
        }

<!--        #calendar {-->
<!--          max-width: 900px;-->
<!--          margin: auto;-->
<!--        }-->

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #eventModal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0; top: 0;
          width: 100%; height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
        }

        #modalContent {
          background-color: #fff;
          margin: 15% auto;
          padding: 20px;
          width: 300px;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        #modalContent input {
          width: 100%;
          padding: 6px;
          margin-bottom: 10px;
        }

        #modalButtons {
          text-align: right;
        }

        #modalButtons button {
          margin-left: 10px;
        }
    </style>
</head>
<body>
<div id='calendar'></div>
<div id="eventModal">
    <div id="modalContent">
        <h3>ì¼ì • ì¶”ê°€</h3>
        <input type="text" id="eventTeam" placeholder="ë‹¨ìœ„ê³¼ì œëª…(ex) 1-1)" />
        <input type="text" id="eventTitle" placeholder="ì¼ì • ì œëª©" />
        <textarea style="margin-bottom: 10px; width: 100%; padding: 6px;" id="eventContent" placeholder="ë‚´ìš©" rows="3"></textarea>
        <div id="eventTime">
        <div style="font-size: 15px;">ì‹œì‘ì‹œê°„</div>
        <input type="time" id="eventStartTime" />
        <div style="font-size: 15px;">ì¢…ë£Œì‹œê°„</div>
        <input type="time" id="eventEndTime" />
        </div>
        <div id="modalButtons">
            <button id="cancelBtn">ì·¨ì†Œ</button>
            <button id="saveBtn">ì €ì¥</button>
        </div>
    </div>
</div>

<div id="viewModal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%);
  background:white; padding:20px; border:1px solid #ccc; border-radius:8px; z-index:2000; width:300px;">
    <h3 id="viewTitle">ì œëª©</h3>
    <p><strong>ë‹¨ìœ„ê³¼ì œëª…</strong>:</strong> <span id="viewTeam"></span></p>
    <p><strong>ì‹œê°„:</strong> <span id="viewTime"></span></p>
    <p style="margin-bottom: 10px; width: 100%;"><strong>ë‚´ìš©:</strong></p>
    <p id="viewContent"></p>
    <div style="text-align: right;">
        <button id="editBtn">ìˆ˜ì •</button>
        <button id="deleteBtn" style="margin-left: 8px;">ì‚­ì œ</button>
        <button onclick="document.getElementById('viewModal').style.display='none'" style="margin-left: 8px;">ë‹«ê¸°</button>
    </div>
</div>
<div style="margin-top:5px">* ëª¨ë°”ì¼ì—ì„œ ìº˜ë¦°ë” ì„ íƒí•  ë•Œ í„°ì¹˜ê°€ ì•ˆ ëœë‹¤ë©´ 2ì´ˆ ì •ë„ ê¸¸ê²Œ í„°ì¹˜í•´ ì£¼ì„¸ìš”.</div>
</body>
<script>

    document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    const modal = document.getElementById('eventModal');
    const titleInput = document.getElementById('eventTitle');
    const startInput = document.getElementById('eventStartTime');
    const endInput = document.getElementById('eventEndTime');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
      headerToolbar: {
    left: 'prev,next today',
    center: 'title',
    right: 'dayGridMonth,timeGridWeek,timeGridDay' // ë²„íŠ¼ ì¶”ê°€
  },
  views: {
    dayGridMonth: {
      buttonText: 'ì›”ê°„'
    },
    timeGridWeek: {
      buttonText: 'ì£¼ê°„'
    },
    timeGridDay: {
      buttonText: 'ì¼ê°„'
    }
  },
    locale: 'ko',
    timeZone: 'local',
    events: '/api/events', // Spring Boot APIì™€ ì—°ê²°
 eventContent: function(info) {
  const team = info.event.extendedProps.team || '';
  const title = info.event.title || '';
  const start = new Date(info.event.start);
  const end = new Date(info.event.end);

  // ì‹œê°„ë§Œ í¬ë§· (ì˜ˆ: 09:00)
  const formatTime = (date) => {
      const hours = date.getHours();
    const minutes = date.getMinutes();

    const isAM = hours < 12;
    const ampm = isAM ? 'ì˜¤ì „' : 'ì˜¤í›„';

    return date.toLocaleTimeString('ko-KR', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });
  };

  const timeRange = `${formatTime(start)} ~ ${formatTime(end)}`;

  return {
    html: `
    <div style="
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;">
      <div style="font-weight:bold;">(${team}) ${title}</div>
      <div style="font-size: 0.85em; color: #FFFFFF;">${timeRange}</div>
      </div>
    `
  };
},
        editable: true,
        selectable: true,
eventDrop: function(info) {
  const event = info.event;

  // ğŸ“Œ ë‚ ì§œëŠ” UTC ë§ê³  ë¡œì»¬ ê¸°ì¤€ìœ¼ë¡œ ìƒì„±
  const datePart = [
    event.start.getFullYear(),
    (event.start.getMonth() + 1).toString().padStart(2, '0'),
    event.start.getDate().toString().padStart(2, '0')
  ].join('-');

  const hours = event.start.getHours().toString().padStart(2, '0');
  const minutes = event.start.getMinutes().toString().padStart(2, '0');
  const start = `${datePart}T${hours}:${minutes}:00`;

  const endHours = event.end ? event.end.getHours().toString().padStart(2, '0') : hours;
  const endMinutes = event.end ? event.end.getMinutes().toString().padStart(2, '0') : minutes;
  const end = `${datePart}T${endHours}:${endMinutes}:00`;

  fetch(`/api/events/${event.id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title: event.title,
      team: event.extendedProps.team,
      content: event.extendedProps.content,
      start: start,
      end: end
    })
  }).then(res => {
    if (!res.ok) {
      alert('ì¼ì • ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      info.revert();
    }
  }).catch(err => {
    console.error(err);
    alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    info.revert();
  });
},

eventResize: function(info) {
  const event = info.event;

  // ğŸ“Œ ë‚ ì§œëŠ” UTC ë§ê³  ë¡œì»¬ ê¸°ì¤€ìœ¼ë¡œ ìƒì„±
  const datePart = [
    event.start.getFullYear(),
    (event.start.getMonth() + 1).toString().padStart(2, '0'),
    event.start.getDate().toString().padStart(2, '0')
  ].join('-');

  const hours = event.start.getHours().toString().padStart(2, '0');
  const minutes = event.start.getMinutes().toString().padStart(2, '0');
  const start = `${datePart}T${hours}:${minutes}:00`;

  const endHours = event.end ? event.end.getHours().toString().padStart(2, '0') : hours;
  const endMinutes = event.end ? event.end.getMinutes().toString().padStart(2, '0') : minutes;
  const end = `${datePart}T${endHours}:${endMinutes}:00`;

  fetch(`/api/events/${event.id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title: event.title,
      team: event.extendedProps.team,
      content: event.extendedProps.content,
      start: start,
      end: end
    })
  }).then(res => {
    if (!res.ok) {
      alert('ì¼ì • ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      info.revert();
    }
  }).catch(err => {
    console.error(err);
    alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    info.revert();
  });
},
  eventClick: function(info) {
  const event = info.event;

  const title = event.title || '';
  const team = event.extendedProps.team || '';
  const content = event.extendedProps.content || '';
  const start = new Date(event.start);
  const end = new Date(event.end);

  const formatTime = (date) => {
    const hours = date.getHours();
    const minutes = date.getMinutes();
    const ampm = hours < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
    const hour12 = hours % 12 === 0 ? 12 : hours % 12;
    return `${ampm} ${hour12}ì‹œ ${minutes.toString().padStart(2, '0')}ë¶„`;
  };

  document.getElementById('viewTitle').textContent = title;
  document.getElementById('viewTeam').textContent = team;
  document.getElementById('viewTime').textContent = `${formatTime(start)} ~ ${formatTime(end)}`;
  document.getElementById('viewContent').textContent = content;

  // ì‚­ì œ ë²„íŠ¼
  document.getElementById('deleteBtn').onclick = () => {
    if (confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      fetch(`/api/events/${event.id}`, { method: 'DELETE' })
        .then(() => {
          calendar.refetchEvents();  // ë‹¤ì‹œ ë¡œë“œ
          document.getElementById('viewModal').style.display = 'none';
        });
    }
  };

  function openEditModal(event) {
  const modal = document.getElementById('eventModal');
  const titleInput = document.getElementById('eventTitle');
  const teamInput = document.getElementById('eventTeam');
  const contentInput = document.getElementById('eventContent');
  const startInput = document.getElementById('eventStartTime');
  const endInput = document.getElementById('eventEndTime');
  const saveBtn = document.getElementById('saveBtn');

  // ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
  titleInput.value = event.title || '';
  teamInput.value = event.extendedProps.team || '';
  contentInput.value = event.extendedProps.content || '';
  // ìœ í‹¸ í•¨ìˆ˜: ì‹œ/ë¶„ì„ í•­ìƒ ë‘ ìë¦¬ë¡œ í¬ë§·
function pad(num) {
  return num.toString().padStart(2, '0');
}

startInput.value = `${pad(event.start.getHours())}:${pad(event.start.getMinutes())}`;
endInput.value = `${pad(event.end.getHours())}:${pad(event.end.getMinutes())}`;

  modal.style.display = 'block';

  // ê¸°ì¡´ saveBtn ì´ë²¤íŠ¸ ì œê±° í›„ ìƒˆë¡œìš´ ìˆ˜ì • ì´ë²¤íŠ¸ ë°”ì¸ë”©
  const newSaveBtn = saveBtn.cloneNode(true);
  saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

  newSaveBtn.onclick = () => {
    const updatedTitle = titleInput.value;
    const updatedTeam = teamInput.value;
    const updatedContent = contentInput.value;
    let updatedStart, updatedEnd;

function toLocalDateString(date) {
  const offset = date.getTimezoneOffset() * 60000;
  return new Date(date.getTime() - offset).toISOString().slice(0, 10);
}


const selectedDate = event.start.toISOString().slice(0, 10);

    const dateStr = toLocalDateString(event.start);
    updatedStart = `${dateStr}T${startInput.value}:00`;
    updatedEnd = `${dateStr}T${endInput.value}:00`;

    if (!startInput.value || !endInput.value) {
        alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    if (!updatedTitle || !startInput.value || !endInput.value) {
      alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    fetch(`/api/events/${event.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: updatedTitle,
        team: updatedTeam,
        content: updatedContent,
        start: updatedStart,
        end: updatedEnd
      })
    }).then(() => {
      modal.style.display = 'none';
      calendar.refetchEvents();
    });
  };
}


  // ìˆ˜ì • ë²„íŠ¼
  document.getElementById('editBtn').onclick = () => {
    // ê¸°ì¡´ ì¼ì • ëª¨ë‹¬ì„ ìˆ˜ì • ëª¨ë“œë¡œ ì—´ê³ , ê¸°ì¡´ ê°’ ì±„ì›Œë„£ê¸°
    openEditModal(event);
    document.getElementById('viewModal').style.display = 'none'; // ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
  };

  document.getElementById('viewModal').style.display = 'block';
},
        eventDidMount: (info) => {
  const team = info.event.extendedProps.team || '';
  let bgColor = '#013682'; // ê¸°ë³¸ìƒ‰

  if (team.startsWith('1-1')) {
    bgColor = '#d7a4be'; // ë¶„í™
  } else if (team.startsWith('1-2')) {
    bgColor = '#e45965';
  } else if (team.startsWith('1-3')) {
    bgColor = '#c14473';
  } else if (team.startsWith('3-1')) {
    bgColor = '#49a587';
  }else if (team.startsWith('3-2')) {
      bgColor = '#248457';
  } // ì´ˆë¡
   else if (team.startsWith('4-1')) {
    bgColor = '#dcab65';
   }
   else if(team.startsWith('4-5')){
    bgColor = '#b97924'; // í™©í† 
  }

  // ë°°ê²½ìƒ‰ ì ìš©
  info.el.style.backgroundColor = bgColor;
  info.el.style.borderColor = bgColor;

  info.el.style.color = '#ffffff';
},
        select: function(info) {

        document.getElementById('eventContent').value = '';
        selectedDate = info.startStr.split("T")[0]; // ë‚ ì§œë§Œ ì €ì¥
        titleInput.value = '';
        startInput.value = '09:00';
        endInput.value = '10:00';
        modal.style.display = 'block';
}
});

    eventClick: (info) => {
        if (confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          fetch(`/api/events/${info.event.id}`, { method: 'DELETE' })
            .then(() => calendar.refetchEvents());
        }
      }
      calendar.render();

      saveBtn.onclick = () => {

        const allDayCheckbox = document.getElementById('allDayCheckbox');
        const eventTimeDiv = document.getElementById('eventTime');

       let start, end;
       const startTime = startInput.value;
       const endTime = endInput.value;

      const title = titleInput.value;
      const team = document.getElementById('eventTeam').value;
      const content = document.getElementById('eventContent').value;

    start = `${selectedDate}T${startTime}:00`;
    end = `${selectedDate}T${endTime}:00`;

    if (!startTime || !endTime) {
        alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }


      if (!title) {
        alert('ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      fetch('/api/events', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: title,
          team: team,
          content: content,
          start: start,
          end: end
        })
      }).then(() => {
        modal.style.display = 'none';
        calendar.refetchEvents();
      });
    };

    cancelBtn.onclick = function () {
      modal.style.display = 'none';
    };
  });

</script>
</html>